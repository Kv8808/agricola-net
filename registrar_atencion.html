<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Registrar Atención</title>
<style>
body{font-family:Arial;background:#2e7d32;color:white;text-align:center}
form{background:rgba(0,0,0,0.5);width:400px;margin:40px auto;padding:20px;border-radius:10px}
input, select, button{width:100%;padding:8px;margin:8px 0}
button{background:#4caf50;color:white;border:none;cursor:pointer}
button:hover{background:#66bb6a}
</style>
</head>
<body>
<h2>REGISTRAR ATENCIÓN</h2>

<form id="form">
  <select id="id_empleado" required>
    <option value="">SELECCIONA EMPLEADO</option>
    <option value="1">Juan Pérez</option>
    <option value="2">María López</option>
    <option value="3">Carlos Gómez</option>
  </select>

  <input id="nombre_cliente" type="text" placeholder="Nombre del cliente" required>
  <input id="producto" type="text" placeholder="Producto" required>
  <input id="monto" type="number" step="0.01" placeholder="Monto" required>
  <input id="fecha" type="date" required>

  <button type="submit">REGISTRAR</button>
</form>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  // --- REEMPLAZA con tus datos de Supabase ---
  const SUPABASE_URL = 'https://dclodqpggfezfqjzsrdx.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjbG9kcXBnZ2ZlemZxanpzcmR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODE3MDgsImV4cCI6MjA4NzY1NzcwOH0.iPMP7wFXTkZMnI6LtG3CIgi_mQUxsBvU_oaRomVbNhM'
  // --------------------------------------------
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  // esperar a que exista el formulario (script está al final del body)
  const form = document.getElementById('form')
  if (!form) {
    console.error('No se encontró el formulario #form')
  } else {
    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      // obtener usuario autenticado
      const { data: { user }, error: userError } = await supabase.auth.getUser()
      if (userError) {
        console.error('Auth getUser error:', userError)
        alert('Error de autenticación: ' + userError.message)
        return
      }
      if (!user) {
        alert('Debes iniciar sesión antes de registrar una atención.')
        window.location.href = 'login.html'
        return
      }

      const id_empleado = parseInt(document.getElementById('id_empleado').value)
      const nombre_cliente = document.getElementById('nombre_cliente').value.trim()
      const producto = document.getElementById('producto').value.trim()
      const monto = parseFloat(document.getElementById('monto').value)
      const fecha = document.getElementById('fecha').value

      if (!nombre_cliente || !producto || isNaN(monto) || !fecha) {
        alert('Rellena todos los campos correctamente.')
        return
      }

      const { data, error } = await supabase
        .from('atenciones')
        .insert([{
          id_empleado,
          nombre_cliente,
          producto,
          monto,
          fecha,
          user_id: user.id
        }])

      if (error) {
        console.error('Insert error:', error)
        alert('Error: ' + error.message)
        return
      }
      alert('Atención registrada')
      window.location.href = 'ver_atenciones.html'
    })
  }
</script>
</body>
</html>