<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  // REEMPLAZA con tus datos (ya los tienes)
  const SUPABASE_URL = 'https://dclodqpggfezfqjzsrdx.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjbG9kcXBnZ2ZlemZxanpzcmR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODE3MDgsImV4cCI6MjA4NzY1NzcwOH0.iPMP7wFXTkZMnI6LtG3CIgi_mQUxsBvU_oaRomVbNhM'
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  const form = document.getElementById('form')
  form.addEventListener('submit', async (e) => {
    e.preventDefault()

    // obtener usuario autenticado
    const { data: { user }, error: userError } = await supabase.auth.getUser()
    if (userError) {
      console.error(userError)
      alert('Error auth: ' + userError.message)
      return
    }
    if (!user) {
      alert('Debes iniciar sesi칩n antes de registrar una atenci칩n.')
      window.location.href = 'login.html'
      return
    }

    // datos del formulario
    const id_empleado = parseInt(document.getElementById('id_empleado').value)
    const nombre_cliente = document.getElementById('nombre_cliente').value.trim()
    const producto = document.getElementById('producto').value.trim()
    const monto = parseFloat(document.getElementById('monto').value)
    const fecha = document.getElementById('fecha').value

    // validaciones b치sicas (evitan errores)
    if (!nombre_cliente || !producto || isNaN(monto) || !fecha) {
      alert('Rellena todos los campos correctamente.')
      return
    }

    // insertar incluyendo user_id = user.id
    const { data, error } = await supabase
      .from('atenciones')
      .insert([{
        id_empleado,
        nombre_cliente,
        producto,
        monto,
        fecha,
        user_id: user.id
      }])

    if (error) {
      alert('Error: ' + error.message)
      console.error(error)
      return
    }
    alert('Atenci칩n registrada')
    window.location.href = 'ver_atenciones.html'
  })
</script>