<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Ver Atenciones</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:Arial;background:#1b5e20;color:white;text-align:center;padding:20px}
  table{margin:20px auto;border-collapse:collapse;width:95%;max-width:1000px}
  th, td{border:1px solid white;padding:8px}
  a{color:#81c784;text-decoration:none;font-weight:bold}
  .pagination{margin:12px}
  .button{background:#4caf50;color:white;padding:6px 10px;border-radius:6px;text-decoration:none;display:inline-block}
</style>
</head>
<body>

<h2>LISTA DE ATENCIONES</h2>
<div id="table-wrap"></div>

<div class="pagination">
  <button id="prev">Anterior</button>
  <span id="pageInfo"></span>
  <button id="next">Siguiente</button>
</div>

<p><a href="index.html">Volver al inicio</a></p>

<script type="module">
  import { supabase } from './js/supabaseClient.js'

  // Protege la p치gina: s칩lo admin
  (async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) return window.location.href = 'login.html'

      const { data: { user }, error } = await supabase.auth.getUser()
      if (error) throw error

      if (!user?.app_metadata?.role || user.app_metadata.role !== 'admin') {
        alert('Acceso restringido: solo administradores')
        return window.location.href = 'index.html'
      }
    } catch (err) {
      console.error('Protecci칩n error', err)
      await supabase.auth.signOut()
      window.location.href = 'login.html'
    }
  })()

  let page = 1, limit = 10
  const tableWrap = document.getElementById('table-wrap')
  const pageInfo = document.getElementById('pageInfo')
  const prevBtn = document.getElementById('prev')
  const nextBtn = document.getElementById('next')

  function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

  async function load() {
    try {
      const from = (page - 1) * limit
      const to = from + limit - 1

      const { data, error, count } = await supabase
        .from('atenciones')
        .select('*', { count: 'exact' })
        .order('fecha', { ascending: false })
        .range(from, to)

      if (error) throw error

      const total = count || 0
      const pages = Math.max(1, Math.ceil(total / limit))
      pageInfo.textContent = `P치gina ${page} de ${pages} - Total: ${total}`

      const rows = (data || []).map(row => `
        <tr>
          <td>${row.id_atencion}</td>
          <td>${row.id_empleado}</td>
          <td>${escapeHtml(row.nombre_cliente)}</td>
          <td>${escapeHtml(row.producto)}</td>
          <td>${row.monto}</td>
          <td>${row.fecha}</td>
          <td>
            <a class="button" href="editar_atencion.html?id=${row.id_atencion}">Editar</a>
            <a class="button" data-id="${row.id_atencion}" href="#" onclick="del(event)">Eliminar</a>
          </td>
        </tr>
      `).join('')

      tableWrap.innerHTML = `
        <table>
          <tr>
            <th>ID</th><th>Empleado</th><th>Cliente</th><th>Producto</th><th>Monto</th><th>Fecha</th><th>Acciones</th>
          </tr>
          ${rows}
        </table>
      `
      prevBtn.disabled = page <= 1
      nextBtn.disabled = page >= pages
    } catch (err) {
      console.error('Load error:', err)
      tableWrap.innerHTML = '<p>Error al cargar: ' + (err.message || err) + '</p>'
    }
  }

  prevBtn.addEventListener('click', ()=>{ if (page>1) { page--; load() } })
  nextBtn.addEventListener('click', ()=>{ page++; load() })

  window.del = async function(e){
    e.preventDefault()
    const id = e.currentTarget.getAttribute('data-id')
    if(!confirm('Eliminar registro #' + id + '?')) return
    try {
      const { error } = await supabase.from('atenciones').delete().eq('id_atencion', id)
      if (error) throw error
      alert('Eliminado')
      load()
    } catch (err) {
      console.error('Delete error', err)
      alert('Error al eliminar: ' + (err.message || err))
    }
  }

  // cargar inicialmente
  load()
</script>
</body>
</html>